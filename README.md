<h1 align="center">
  <a href="#">Node Deployment Manager</a>
</h1>
<h3 align="left">
 Automatic and Continuous Deployment Manager for Node.js projects.
</h3>

<h4 align="left">
This project configures an automatic deployment process that executes when changes are submited to repositories. Pipelines perform dependency instalation, testing, building and when sucessfull replace the application instance with the new version.
</h4>

The program uses an interactive setup process to configure project's repositories and their deployment pipelines. It also manages the app instance process so that it can restart it when new versions are available. It also supports reconfiguration, watching logs, and eventually automatic rollback.

## Purpose

Updates cause the asynchronous deployment process to start. It runs in an isolated process and performs these steps by default:

 - Checkout the new version to `./deployment/new-instance`
 - Copies configurations and data folders from the running instance
 - Install project dependencies (copying if unchanged)
 - Execute the build script (`npm run build`) from `package.json` 
 - Execute the test script (`npm run test`) from `package.json` 
 - Backup the contents of the current project folder to `./deployment/previous-instance`
 - Stop the current instance process of the app
 - Move the new project files to the project folder at `./deployment/current-instance`
 - Spawn the instance process again with the new files

The [post-update](https://git-scm.com/docs/githooks) hook (configured by this script) triggers the process and the logs from the instance process and the deployment pipelines are written to `instance.log` and `deployment.log` respectively. The process id of the instance is stored at `instance.pid` when it spawns and it is removed when the instance process exits.

## Usage

The root file `node-deploy.cjs` is a CommonJS Node.js script generated by the build process of this project. It is standalone  and can be executed direcly with the following command:

```bash
node -e "fetch('https://raw.githubusercontent.com/GuilhermeRossato/node-deployment/master/node-deploy.cjs').then(r=>r.text()).then(t=>new Function(t)()).catch(console.log))"
```

You can also download the script locally from this project with curl/wget/node:

```bash
curl -o node-deploy.cjs https://raw.githubusercontent.com/GuilhermeRossato/node-deployment/master/node-deploy.cjs
wget https://raw.githubusercontent.com/GuilhermeRossato/node-deployment/master/node-deploy.cjs -O node-deploy.cjs
node -e "fetch('https://raw.githubusercontent.com/GuilhermeRossato/node-deployment/master/node-deploy.cjs').then(r=>r.text()).then(t=>fs.promises.writeFile('node-deploy.cjs', t, 'utf-8')).catch(console.log))"
```

## Setup

The setup mode is the default and it creates a git bare repository to store a project data related to git (commits, branches, etc) and a `deployment` folder for things related to deployment such as logs, status, process ids, scripts, and backup folders.

The [post-update](https://git-scm.com/docs/githooks) hook is configured to schedule asyncronous deployments when commits are pushed to the repository. A pipeline starts by creating a new release folder (`./deployment/upcoming-instance`), if it fails the folder is renamed to `failed-instance`, otherwise (on success) the contents of the new version are moved to the configured instance folder and the project instance is restarted. The contents of the instance previously in executing are moved to `./deployment/previous-instance` and can be used to restore the version by moving it back to its original location.

## Program modes

    --help / -h           Display help text
    --setup               Initialize and setup a project for automatic deployment (default)
    --config              Change settings and configure projects interactively
    --status              Retrieve status information from the manager process
    --logs                Print the latest log data continuously
    --start / --restart   Start or restart the manager process and display its status
    --shutdown            Stop the instance manager process from executing

The "--status"  mode can be combined with "--restart" to restart the manager process or with "--start" to start it only if it is not running.
## Flags

   --debug / -d           Enable verbose mode and include extra logs during execution
   --yes / -y             Assume yes to any interactive user confirmations
   --dry-run / --dry      Disable side-effects and simulate execution without writing files
   --sync / --wait        Execute child process syncronously
   
## Advanced modes

    --schedule            Manually schedule an asyncronous deployment of the project
    --schedule <commit>   Schedules deployment of a specific version of the project by commit
    --schedule <ref>      Schedules deployment specifying the project version by a reference
    --process             Execute the deployment pipeline syncronously
    --process <commit>    Execute the deployment at a specific commit
    --process <rev>       Execute a deployment pipeline at a specific branch reference
    --manager             Run this program to manage the project instance synchronously

## Tips

If you have SSH access you can send the deployment script from the client to the server with `scp` and execute it directly:

```bash
wget https://raw.githubusercontent.com/GuilhermeRossato/node-deployment/master/index.js -O node-deploy.cjs
scp ./node-deploy.cjs [username]@[hostname]:~/Downloads/node-deploy.cjs
ssh [username]@[hostname] "node ~/Downloads/node-deploy.cjs"
```

New repositores can be cloned from remote git repositores with `git clone ssh://[[username]]@[[hostname]]:[[port]]/[[git-bare-path]]` and existing repositories can be configured to pull (fetch) and to push (submit) changes to a remote server with git:

```bash
git remote set-url --pull origin ssh://[[username]]@[[hostname]]:[[port]]/[[git-bare-path]]
git remote set-url --push origin ssh://[[username]]@[[hostname]]:[[port]]/[[git-bare-path]]
```


## Dependencies

This project handles repositories with [git](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git) and runs with [node](https://nodejs.org/en). It does not depend on any npm packages.

## Objective

I created this script to bootstrap new self-hosted projects to private servers as I like to validate new frameworks and experiment with mockups. Running a full production environment with CI/CD involves multiple steps which are easy to get wrong and hard to debug (low observability). This script organize the most common CI/CD process for modern Node.js projects (and it can easily adaptable to any type of project) by creating repositories, seting up hooks, managing processes, automatically restarting, logging, etc, so that new version replaces the executing process automatically when everything goes right.

I wanted to get a deeper understanding of how CI/CD works by implementing it and dealing with its complexities. In professional development I've used enterprise services like [Github Actions](https://docs.github.com/en/actions), [Bitbucket Pipelines](https://bitbucket.org/product/features/pipelines) and [Google App Engine](https://cloud.google.com/build/docs/deploying-builds/deploy-appengine) and they are amazing for development and have great features, the only downside is that they are either slow, expensive, or unflexible.

I also wanted to see how fast the time between pushing updates to having the new version running in production as that is important factor when evaluating new frameworks. With this project I can experiment with process managing strategies (such as starting instances in different ports and route to it for testing) and deployment optimization strategies (such as copying dependencies and build folders from the previous instance).
